/* ******************************************* *
 * Home.min.js                                 *
 * (c) 2013 Danny Hadley under the MIT license *
 * ******************************************* */
(function(){var c,d=hexo.Utils,a,j,b,h,i,e,g,k,f;k=function(n){var l={room_id:n.id,room_count:n.count,room_name:n.name},m=d.template("chatroom-list-item",l);document.getElementById("open-chat-listing").innerHTML+=m};g=function(l){var m=l.room_name;i();return hexo.Chat.makeRoom(m,k)};i=function(l){if(l&&l.keyCode&&l.keyCode!==27){return}$("#new-room-factory").stop().animate({bottom:"-400px"},d.anTime,d.anEase,function(){});$(document).off("keydown",i)};h=function(){$("#new-room-factory").stop().animate({bottom:"0px"},d.anTime,d.anEase,function(){});$(document).on("keydown",i)};e=function(){var l=$(this),m=l.data("id");hexo.Chat.joinRoom(m)};f=(function(){var s={},r={container:"#online-list",roomcontainer:"#open-chat-listing",socket_url:"/chat/state",challenge_url:"/game/challenge",template:"online-user",roomtemplate:"chatroom-list-item-template"},m=function(t){return{csrf_token:j,target:t,token:a.token}},o,q,l,p,n;n=function(t){if(!t||!t.success){return false}document.location="/game/play"};p=function(){var t=$(this),u=t.data("user");$.post(r.challenge_url,m(u),n)};s.update=function(u){if(d.type(u)!=="object"){return false}q.html("");hexo.Geo.clearMarkers();var t="";_.each(u.users,function(v){t+=d.template(r.template,v);hexo.Geo.addMarker(v.location,v.username)});q.html(t);l.html("");t="";_.each(u.rooms,function(v){var w={room_id:v.id,room_count:v.count,room_name:v.name};t+=d.template(r.roomtemplate,w)});l.html(t)};s.init=function(t){d.l("setting up online user list");$.extend(r,t);q=$(r.container);l=$(r.roomcontainer);q.on("click","button.challenge",p);l.parent().parent().on("click","button.add-new",h);l.on("click","button.quick-join",e);o=hexo.Socket({url:r.socket_url,token:a.token,events:{update:_.bind(s.update,s)}});o.open();o.force()};return s})();c=function(l,m){d.l("setting up homepage");a=l;j=m;f.init();b=new IV({form:document.getElementById("new-room-form"),callback:g});hexo.Chat.openRoom(hexo.Chat.getUID("General Chat"))};hexo.Entry(c)})();