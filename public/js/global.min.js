var DEBUGGING=false;(function(m){var l,r=m,f=r.document,b=r.$,x=new Date().getTime(),q="",s=null,p={},e=false,d=false,n,v,k,t={},u,i,g,c,j,o,a,h;k=function(){};n=function(){b("html, body").stop().animate({scrollTop:"0px"},600)};j=function(w){return new j.ns.rig(w)};j.prototype=j.ns=(function(){var C={constructor:j,version:"1.0",ready:false,url:false,callback:false},B={},A={close:k,update:k},w=function(){return{usr:{token:s.token},csrf_token:q,token:this.token,extras:this.extras,flag:this.flag,raw:(this.raw===true)?"raw":false}},y=function(D){if(D.flag){this.flag=D.flag}if(D.flag=="dead"){this.close();this.ready=false;this.looping=false;this.events.close();g.l("Socket #"+this.uid+": was terminated on the server end");return false}else{if(!D.success){g.l("Socket #"+this.uid+": the socket was unsuccessful","err");this.events.close();this.ready=false;return false}}if(parseInt(D.code,10)==1){g.l("Socket #"+this.uid+": package received");this.events.update(D["package"]||{})}else{g.l("Socket #"+this.uid+": no package received -> restarting")}},z=function(D){if(D!==undefined&&g.type(D)==="object"){y.call(this,D)}if(this.looping===true&&this.ready===true){setTimeout(_.bind(function(){B[this.uid]=b.post(this.url,w.call(this),_.bind(z,this),"json")},this),1000)}};C.rig=function(D){if(!D||D===undefined||g.type(D)!=="object"){return false}this.url=D.url||false;this.events=b.extend({},A,D.events);this.token=D.token;this.flag=D.flag;this.extras=D.extras||{};this.uid=g.uid();this.raw=false;if(this.url===false){return false}this.ready=true};C.force=function(){var D=(function(E){return(function(F){y.call(E,F)})})(this);g.l("forcing socket #"+this.uid);this.raw=true;b.post(this.url,w.call(this),D,"json");this.raw=false};C.open=function(){if(!this.ready){return false}g.l("Socket #"+this.uid+": opening up");this.looping=true;z.call(this)};C.close=function(){this.looping=false;this.ready=false;if(B[this.uid]){B[this.uid].abort()}};return C})();j.ns.rig.prototype=j.ns;h=function(w){return new h.ns.rig(w)};h.ns=h.prototype=(function(){var A={version:"1.0",constructor:h},z={challenge_url:"/game/challenge",add_url:"/socket/addfriend",};function y(B){return{csrf_token:q,target:B,token:s.token}}function w(B){}A.rig=function(B){if(!B||B==undefined){return false}this.username=B.username||"N/A";this.wins=(g.pint(B.wins))?g.pint(B.wins):0;this.losses=(g.pint(B.losses))?g.pint(B.losses):0;this.hb_flag=B.hb_flag||false;this.active=B.active||false;if(this.active!==false){s=this}this.token=B.token||false};A.addFriend=function(C,B){$.post(z.add_url,y(C),B||w)};A.challengeUser=function(C,B){$.post(z.challenge_url,y(C),B||w)};return A})();h.ns.rig.prototype=h.ns;o=a=function(w,y){return new a.ns.rig(w,y)};a.ns=a.prototype=(function(){var C={constructor:a,version:"1.0"},B={update:k},z=function(D){var E={msg:D.message||false,chat_token:this.chat_token,user_token:this.user_token,usr:{token:s.token},csrf_token:q};return E},y=function(F){var E=this.dom.$scrollArea,J=this.dom.$scrollBar,I=E.scrollTop(),G=this.dom.$messageZone.height(),H=I/(G-160),D=H*200+"px";J.css("top",D)},w=function(E){var F=this.dom.$room,D=this.dom.$scrollArea,G=this.dom.$messageZone;G.html("");_.each(E,function(K){var I=K.user||"",J=K.message||"",H=g.template("chat-message-template",{user:I,text:J});G.get()[0].innerHTML+=H});D.scrollTop(G.height()+1000)},A=function(){p[this.uid]=this;var F=this.name.replace(/\s+/g,"_").toLowerCase(),G={room_id:F+"-"+this.uid,room_name:this.name},H={},E,D;H.roomHTML=g.template("chatroom-tempate",$.extend({},G,this));H.listHTML=g.template("charoom-listitem-template",$.extend({},G,this));if(e===false){e=b("#chatroom-pullout");d=b("#chatlist-menu-list")}E=$("<section>").html(H.roomHTML),D=$("<li>").addClass("active-room t cf").html(H.listHTML);e.append(E);d.append(D);H.$room=E;H.$listItem=D;H.$scrollArea=E.find("div.chat-scroll-area").on("scroll",_.bind(y,this));H.$scrollBar=E.find("span.chat-scroll-bar");H.$messageZone=E.find("section.chat-window");this.dom=H;this.ready=true;this.events.update=_.bind(w,this);this.registerForm(F+"-"+this.uid+"-form");this.start()};C.receive=function(D){if(!D||!D.messages||!D.messages.length){return false}this.messages=D.messages;this.events.update(this.messages)};C.start=function(){if(!this.ready){g.l("chat room not ready to make calls","err");return false}this.events.update(this.messages);if(!this.open){this.open=true;this.socket.open()}};C.sendCheck=function(D){if(!D.success){g.l("something when wrong in chatroom: "+this.uid,"err");this.socket.close();this.ready=false}else{this.input.$inputs.val("")}};C.send=function(D){if(!this.ready){g.l("chat room not ready to send messages","err");return false}b.post("/chat/send",z.call(this,D),_.bind(this.sendCheck,this))};C.registerForm=function(D){var E;if(g.type(D)=="string"){E=new IV({form:f.getElementById(D),callback:_.bind(this.send,this)})}else{if(g.type(D)=="object"){E=new IV({form:D.form||undefined,callback:_.bind(this.send,this)})}else{E=new IV({callback:k})}}this.input=E;return E};C.close=function(){if(this.dom!==false){this.dom.$room.remove();this.dom.$listItem.remove()}this.socket.close();this.ready=false};C.rig=function(D,E){if(!D||D==undefined){return false}this.ready=false;this.dom=false;this.name=D.name||"N/A";this.uid=g.uid();this.id=D.id||-1;this.events=b.extend({},B,D.events);this.chat_token=D.chat_token||false;this.user_token=D.user_token||false;this.messages=D.messages||[];this.count=D.count;if(this.chat_token===false||this.user_token===false){return false}this.socket=j({flag:D.flag,url:"/socket/chat",events:{update:_.bind(this.receive,this)},token:this.chat_token,extras:{chat_token:this.chat_token,user_token:this.user_token}});if(!E){g.Entry(_.bind(A,this))}this.ready=true;this.open=false};return C})();a.ns.rig.prototype=a.ns;a.renderAll=(function(){var w=false,B=0,A,z,y;y=function(){var D=$(this),C=D.data("uid");return a.leaveRoom(C)};z=function(C){if(C.keyCode&&C.keyCode!==27){return}var E=$(this),D=E.data("uid");return a.closeRoom(D)};A=function(){var D=$(this),C=D.data("uid");return a.openRoom(C)};return function(){_.each(p,function(H){var F=e.find('section.chatroom[data-uid="'+H.uid+'"]'),E=a.openUIDs.indexOf(H.uid),D=(E!==-1)?"0px":"-800px",C=(E!==-1)?"block":"none",G=(E<1)?"0px":(E*320)+"px";F.css({display:C,opacity:"1.0",left:G}).stop().animate({bottom:D},g.anTime,g.anEase)});if(!w){e.off("click",z).on("click","button.closer",z);d.off("click",A).on("click","button.opener",A).on("click","button.closer",y)}w=true}})();a.openUIDs=[];a.closeRoom=function(w){if(!w){return false}a.openUIDs.splice(a.openUIDs.indexOf(w),1);return a.renderAll()};a.openRoom=function(w){if(!w){return false}if(a.openUIDs.indexOf(w)===-1){a.openUIDs.push(w)}return a.renderAll()};a.makeRoom=(function(){var w=false,z=false;function y(A){if(!A.success){return false}if(A.code===6){return a.joinRoom(A.cid)}var B=a(A["package"]);setTimeout(function(){w=false},3000);return a.openRoom(B.uid)}return(function(A,B){if(q===""||s===null||w){return false}z=(!!B)?B:false;w=true;$.post("/chat/open",{name:A,usr:{token:s.token},csrf_token:q},y,"json")})})();a.getUID=function(w){var y=false;_.each(p,function(z){if(z.name===w){y=z.uid}});return y};a.leaveRoom=(function(){var w=false,z=null;function y(B){if(!B.success){return false}var A=z.uid;z.close();delete p[z.uid];w=false;return a.closeRoom(A)}return(function(A){var B=(p.hasOwnProperty(A))?p[A]:false;if(!B||w){return false}z=B;w=true;$.post("/chat/leave",{cid:B.id,usr:s,csrf_token:q},y,"json")})})();a.joinRoom=(function(){var w=false;function y(z){w=false;if(z.code==6){return a.openRoom(a.getUID(z.name))}var A=a(z["package"]);return a.openRoom(A.uid)}return(function(z){if(q===""||s===null||w){return false}w=true;$.post("/chat/join",{cid:z,usr:{token:s.token},csrf_token:q},y,"json")})})();c=g={template:(function(){var z,w,y,A={};y=function(){if($(this).length<1){return false}var D=$(this),B=D.data("name")||g.uid(),C=D.html();A[B]=_.template(C)};w=function(){b('script[type="text/template"]').each(y)};z=function(B,C){if(!A.hasOwnProperty(B)){return false}return A[B](C)};z.load=y;b(f).ready(w);return z})(),uid:(function(){var y=0,w=function(){return Math.floor(Math.random()*100000).toString(36).substring(0,5)};return function(){return w()+(++y)}})(),tsm:function(w,y){return"translate("+w+","+y+")"},pint:function(w){return parseInt(w,10)},type:(function(){var w=Object.prototype.toString,z={"[object Array]":"array","[object Function]":"function","[object Object]":"object","[object Number]":"number","[object String]":"string","[object Boolean]":"boolean"},y=function(A){var B=w.call(A);return z[B]||B};return y})(),Entry:(function(){var z,y=[],w=false,A;A=function(){if(w){return false}for(var B=0;B<y.length;B++){y[B](s,q)}w=true};z=function(C,B){if(g.type(C)!=="function"){return false}y.push(C);if(w){C(s)}return true};b(f).ready(A);return z})(),l:(function(A){if(A==false){return k}var y=function(B){return r.console.log("["+B+"]")},w=function(B){return r.console.dir(B)},z=function(B){return r.console.error("!! "+B)};return function(C,B){if(!DEBUGGING){return false}if(!B){return y(C)}switch(B){case"log":y(C);break;case"dir":w(C);break;case"err":z(C);break;default:y(C);break}return}})(!!r.console),notify:function(w){},anTime:500,anEase:"easeOutCubic",};i=(function(w){if(!w){return{init:k}}var C={},D=false,E=navigator.geolocation,H=null,B=null,L=null,J=[],A=null,y={zoom:3,zoomControl:false,mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:true,styles:[{elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"landscape",stylers:[{color:"#4f4c44"}]},{featureType:"water",stylers:[{color:"#000000"}]},{featureType:"road",stylers:[{visibility:"off"}]},{featureType:"administrative",stylers:[{visibility:"off"}]},{featureType:"poi",stylers:[{visibility:"off"}]},{featureType:"transit",stylers:[{visibility:"off"}]},{featureType:"administrative.province",stylers:[{visibility:"on"},{color:"#ffffff"},{weight:0.7}]},{featureType:"administrative.province",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"administrative.country",stylers:[{visibility:"on"},{weight:1.4},{color:"#ffffff"}]},{featureType:"administrative.country",elementType:"labels",stylers:[{visibility:"off"}]}]},F=function(O){O.cancelBubble=true;if(O.stopPropagation){O.stopPropagation()}},K=function(){_.each(J,function(O){O.setMap(B)})},G=function(){$("#geo-tooltip").text(this.title).stop().animate({bottom:"-30px"},g.anTime,g.anEase)},z=function(){$("#geo-tooltip").stop().animate({bottom:"0px"},g.anTime,g.anEase)},I=function(){google.maps.event.trigger(B,"resize")},M=function(){$(this).stop().animate({height:"200px"},g.anTime,g.anEase,I)},N=function(){$(this).stop().animate({height:"65px"},g.anTime,g.anEase,I)};C.addMarker=function(O,Q){var S=parseFloat(O.lat),P=parseFloat(O.lng);if(S===0||P===0){return false}var T=new google.maps.LatLng(S,P),R=new google.maps.Marker({map:B,position:T,icon:"http://hexo.in/img/other-marker.png",title:Q});google.maps.event.addListener(R,"mouseover",G);google.maps.event.addListener(R,"mouseout",z);J.push(R)};C.clearMarkers=function(){_.each(J,function(O){g.l("clearing");O.setMap(null)});J=[]};C.setPosition=function(O){$("#geo-container").css("display","block");A=$("#geo-zone").css("display","block").hover(M,N).get()[0];var Q={},R=O.coords.latitude,P=O.coords.longitude,S=new google.maps.LatLng(R,P);$.post("/socket/heartbeat",{lat:R,lng:P,csrf_token:q},k);Q.center=S;B=new google.maps.Map(A,$.extend({},y,Q));L=new google.maps.Marker({map:B,position:S,icon:"http://hexo.in/img/marker.png",});K();google.maps.event.addDomListener(A,"mousedown",F);google.maps.event.addDomListener(A,"click",F);google.maps.event.addDomListener(A,"dblclick",F);google.maps.event.addDomListener(A,"contextmenu",F)};C.init=function(){if(!D){E.getCurrentPosition(C.setPosition)}D=true};return C})((!!window.navigator)&&(!!window.navigator.geolocation));u=(function(){var D={},C={menu_id:"#heartbeat-menu",socket_url:"/socket/heartbeat",container:"#notification-list"},B,y=0,z,A,w;w=function(){if(y>0){A.text(y).css("display","block")}else{A.text(0).css("display","none")}};D.update=function(G){if(g.type(G)!=="array"){return false}z.html("");y=G.length;var F="";for(var E=0;E<G.length;E++){if(G[E].type=="game"){F+=g.template("game-notification",G[E])}else{F+=g.template("friend-notification",G[E])}}z.html(F);w()};D.init=function(){g.l("setting up the heartbeat view");v.init(C.menu_id);z=$(C.container);A=$(C.menu_id).find("span.bubble");y=z.children("li").length;B=j({url:C.socket_url,token:s.token,flag:s.hb_flag,events:{update:_.bind(D.update,D)}});B.open();w()};return D})();v=(function(){var A,G,z,y,C,w,B=null,F,E=false,D;C=function(H){if(H.keyCode!==27){return}y.call(this);return H.preventDefault&&H.preventDefault()};z=function(){if(!E){return}if(B!==null){y.call(B)}B=this;this.addClass("open");b(f).on("keydown",_.bind(C,this))};y=function(){if(!E){return}B=null;this.removeClass("open");b(f).off("keydown",_.bind(C,this))};G=function(){if(!E){return}return this.hasClass("open")?y.call(this):z.call(this)};A=function(H){w=b(H);if(w.length<1){return false}F=(function(I){return function(){G.call(I)}})(w);w.on("click","button.toggle",F);E=true};D={open:z,close:y,init:A,toggle:G};return D})();l=function(){e=b("#chatroom-pullout");d=b("#chatlist-menu-list");if(f.getElementById(String(x).substring(0,5))!==null){q=b("#"+String(x).substring(0,5)).find('input[type="hidden"]').val()}if(f.getElementById("settings-menu")!==null){v.init("#settings-menu")}if(f.getElementById("chatist-menu")!==null){v.init("#chatist-menu")}if(f.getElementById("to-top")!==null){b("#to-top").click(n)}if(f.getElementById("heartbeat-menu")!==null){u.init()}if(f.getElementById("geo-zone")!==null){i.init()}if(f.getElementById("chatist-menu")!==null){a.renderAll()}};t.Utils=g;t.Chat=a;t.Socket=j;t.User=h;t.Entry=g.Entry;t.Geo=i;r.hexo=t;t.Entry(l);$.ajaxSetup({dataType:"json"})})(window);