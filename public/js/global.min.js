var DEBUGGING=true;(function(k){var j,p=k,d=p.document,b=p.$,u=new Date().getTime(),o="",q=null,n={},l,t,i,r={},s,g,e,c,h,m,a,f;i=function(){};l=function(){b("html, body").stop().animate({scrollTop:"0px"},600)};h=function(v){return new h.ns.rig(v)};h.prototype=h.ns=(function(){var A={constructor:h,version:"1.0",ready:false,url:false,callback:false},z={},y={close:i,update:i},v=function(){return{usr:{token:q.token},csrf_token:o,token:this.token,extras:this.extras,raw:(this.raw===true)?"raw":false}},w=function(B){if(B.flag&&B.flag=="dead"){this.close();this.ready=false;this.looping=false;this.events.close();e.l("Socket #"+this.uid+": was terminated on the server end");return false}else{if(!B.success){e.l("Socket #"+this.uid+": the socket was unsuccessful","err");this.ready=false;return false}}if(parseInt(B.code,10)==1){e.l("Socket #"+this.uid+": package received");this.events.update(B["package"]||{})}else{e.l("Socket #"+this.uid+": no package received -> restarting")}},x=function(B){if(B!==undefined&&e.type(B)==="object"){w.call(this,B)}if(this.looping===true&&this.ready===true){z[this.uid]=b.post(this.url,v.call(this),_.bind(x,this),"json")}};A.rig=function(B){if(!B||B===undefined||e.type(B)!=="object"){return false}this.url=B.url||false;this.events=b.extend({},y,B.events);this.token=B.token;this.extras=B.extras||{};this.uid=e.uid();this.raw=false;if(this.url===false){return false}this.ready=true};A.force=function(){var B=(function(C){return(function(D){w.call(C,D)})})(this);e.l("forcing socket #"+this.uid);this.raw=true;b.post(this.url,v.call(this),B,"json");this.raw=false};A.open=function(){if(!this.ready){return false}e.l("Socket #"+this.uid+": opening up");this.looping=true;x.call(this)};A.close=function(){this.looping=false;this.ready=false;if(z[this.uid]){z[this.uid].abort()}};return A})();h.ns.rig.prototype=h.ns;f=function(v){return new f.ns.rig(v)};f.ns=f.prototype=(function(){var v={version:"1.0",constructor:f};v.rig=function(w){if(!w||w==undefined){return false}this.username=w.username||"N/A";this.wins=(e.pint(w.wins))?e.pint(w.wins):0;this.losses=(e.pint(w.losses))?e.pint(w.losses):0;this.active=w.active||false;if(this.active!==false){q=this}this.token=w.token||false};return v})();f.ns.rig.prototype=f.ns;m=a=function(v,w){return new a.ns.rig(v,w)};a.ns=a.prototype=(function(){var x={constructor:a,version:"1.0"},w={update:i},v=function(y){var z={msg:y.message||false,chat_token:this.chat_token,user_token:this.user_token,usr:{token:q.token},csrf_token:o};return z};x.receive=function(y){if(!y||!y.messages||!y.messages.length){return false}this.messages=y.messages;this.events.update(this.messages)};x.start=function(){if(!this.ready){e.l("chat room not ready to make calls","err");return false}this.events.update(this.messages);if(!this.open){this.open=true;this.socket.open()}};x.sendCheck=function(y){if(!y.success){e.l("something when wrong in chatroom: "+this.uid,"err");this.socket.close();this.ready=false}else{this.input.$inputs.val("")}};x.send=function(y){if(!this.ready){e.l("chat room not ready to send messages","err");return false}b.post("/chat/send",v.call(this,y),_.bind(this.sendCheck,this))};x.registerForm=function(y){var z;if(e.type(y)=="string"){z=new IV({form:d.getElementById(y),callback:_.bind(this.send,this)})}else{if(e.type(y)=="object"){z=new IV({form:y.form||undefined,callback:_.bind(this.send,this)})}else{z=new IV({callback:i})}}this.input=z;return z};x.close=function(){this.socket.close();this.ready=false};x.rig=function(y,z){if(!y||y==undefined){return false}this.ready=false;this.name=y.name||"N/A";this.uid=e.uid();this.id=y.id||-1;this.events=b.extend({},w,y.events);this.chat_token=y.chat_token||false;this.user_token=y.user_token||false;this.messages=y.messages||[];this.count=y.count;if(this.chat_token===false||this.user_token===false){return false}this.socket=h({url:"/chat/socket",events:{update:_.bind(this.receive,this)},token:this.chat_token,extras:{chat_token:this.chat_token,user_token:this.user_token}});if(!z){n[this.uid]=this}this.ready=true;this.open=false};return x})();a.ns.rig.prototype=a.ns;a.renderAll=(function(){var v=false,C=0,A,w,B,z,x,y;y=function(){var E=$(this),D=E.data("uid");return a.leaveRoom(D)};z=function(D){if(D.keyCode&&D.keyCode!==27){return}var F=$(this),E=F.data("uid");return a.closeRoom(E)};B=function(){var E=$(this),D=E.data("uid");return a.openRoom(D)};x=function(D){var E=A.find('section.chatroom[data-uid="'+this.uid+'"]'),F=E.find("section.chat-window");F.html("");_.each(D,function(J){var H=J.user||"",I=J.message||"",G=e.template("chat-message-template",{user:H,text:I});F.get()[0].innerHTML+=G});F.scrollTop(F.height()+1000)};return function(D,G){A=D||A;w=G||w;var E="",F="";_.each(n,function(J){var H=J.name.replace(/\s+/g,"_").toLowerCase(),I={room_id:H+"-"+J.uid};J.events.update=_.bind(x,J);E+=e.template("chatroom-tempate",$.extend({},I,J));F+=e.template("charoom-listitem-template",$.extend({},I,J))});A.get()[0].innerHTML=E;w.get()[0].innerHTML=F;_.each(n,function(J){var H=J.name.replace(/\s+/g,"_").toLowerCase(),I={room_id:H+"-"+J.uid};J.registerForm(I.room_id+"-form");J.start()});_.each(a.openUIDs,function(H,I){var J=A.find('section.chatroom[data-uid="'+H+'"]');J.css({display:"block",bottom:"0px",opacity:"1.0",left:(I*320)+"px"})});A.off("click",z).on("click","button.closer",z);w.off("click",B).on("click","button.opener",B).on("click","button.closer",y);v=true}})();a.openUIDs=[];a.closeRoom=function(v){if(!v){return false}a.openUIDs.splice(a.openUIDs.indexOf(v),1);return a.renderAll()};a.openRoom=function(v){if(!v){return false}a.openUIDs.push(v);return a.renderAll()};a.makeRoom=(function(){var v=false,x=false;function w(y){if(!y.success){return false}var z=a(y["package"]);if(x&&e.type(x)==="function"){x(z)}setTimeout(function(){v=false},3000);return a.openRoom(z.uid)}return(function(y,z){if(o===""||q===null||v){return false}x=(!!z)?z:false;v=true;$.post("/chat/open",{name:y,usr:{token:q.token},csrf_token:o},w,"json")})})();a.getUID=function(v){var w=false;_.each(n,function(x){if(x.name===v){w=x.uid}});return w};a.leaveRoom=(function(){var v=false,x=null;function w(z){if(!z.success){return false}var y=x.uid;x.close();delete n[x.uid];v=false;return a.closeRoom(y)}return(function(y){var z=(n.hasOwnProperty(y))?n[y]:false;if(!z||v){return false}x=z;v=true;$.post("/chat/leave",{cid:z.id,usr:q,csrf_token:o},w,"json")})})();a.joinRoom=(function(){var v=false;function w(x){v=false;if(x.code==6){return a.openRoom(a.getUID(x.name))}var y=a(x["package"]);return a.openRoom(y.uid)}return(function(x){if(o===""||q===null||v){return false}v=true;$.post("/chat/join",{cid:x,usr:{token:q.token},csrf_token:o},w,"json")})})();c=e={template:(function(){var x,v,w,y={};w=function(){if($(this).length<1){return false}var B=$(this),z=B.data("name")||e.uid(),A=B.html();y[z]=_.template(A)};v=function(){b('script[type="text/template"]').each(w)};x=function(z,A){if(!y.hasOwnProperty(z)){return false}return y[z](A)};x.load=w;b(d).ready(v);return x})(),uid:(function(){var w=0,v=function(){return Math.floor(Math.random()*100000).toString(36).substring(0,5)};return function(){return v()+(++w)}})(),tsm:function(v,w){return"translate("+v+","+w+")"},pint:function(v){return parseInt(v,10)},type:(function(){var v=Object.prototype.toString,x={"[object Array]":"array","[object Function]":"function","[object Object]":"object","[object Number]":"number","[object String]":"string","[object Boolean]":"boolean"},w=function(y){var z=v.call(y);return x[z]||z};return w})(),Entry:(function(){var x,w=[],v=false,y;y=function(){if(v){return false}for(var z=0;z<w.length;z++){w[z](q,o)}v=true};x=function(z){if(e.type(z)!=="function"){return false}w.push(z);if(v){z(q)}return true};b(d).ready(y);return x})(),l:(function(y){if(y==false||!DEBUGGING){return i}var w=function(z){return p.console.log("["+z+"]")},v=function(z){return p.console.dir(z)},x=function(z){return p.console.error("!! "+z)};return function(A,z){if(!z){return w(A)}switch(z){case"log":w(A);break;case"dir":v(A);break;case"err":x(A);break;default:w(A);break}return}})(!!p.console),notify:function(v){},anTime:500,anEase:"easeOutCubic",};g=(function(v){if(!v){return{init:i}}var A={},B=false,C=navigator.geolocation,F=null,z=null,J=null,H=[],y=null,w={zoom:3,zoomControl:false,mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:true,styles:[{elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"landscape",stylers:[{color:"#4f4c44"}]},{featureType:"water",stylers:[{color:"#000000"}]},{featureType:"road",stylers:[{visibility:"off"}]},{featureType:"administrative",stylers:[{visibility:"off"}]},{featureType:"poi",stylers:[{visibility:"off"}]},{featureType:"transit",stylers:[{visibility:"off"}]},{featureType:"administrative.province",stylers:[{visibility:"on"},{color:"#ffffff"},{weight:0.7}]},{featureType:"administrative.province",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"administrative.country",stylers:[{visibility:"on"},{weight:1.4},{color:"#ffffff"}]},{featureType:"administrative.country",elementType:"labels",stylers:[{visibility:"off"}]}]},D=function(M){M.cancelBubble=true;if(M.stopPropagation){M.stopPropagation()}},I=function(){_.each(H,function(M){M.setMap(z)})},E=function(){$("#geo-tooltip").text(this.title).stop().animate({bottom:"-30px"},e.anTime,e.anEase)},x=function(){$("#geo-tooltip").stop().animate({bottom:"0px"},e.anTime,e.anEase)},G=function(){google.maps.event.trigger(z,"resize")},K=function(){$(this).stop().animate({height:"200px"},e.anTime,e.anEase,G)},L=function(){$(this).stop().animate({height:"65px"},e.anTime,e.anEase,G)};A.addMarker=function(M,O){var Q=parseFloat(M.lat),N=parseFloat(M.lng);if(Q===0||N===0){return false}var R=new google.maps.LatLng(Q,N),P=new google.maps.Marker({map:z,position:R,icon:"http://hexo.in/img/other-marker.png",title:O});google.maps.event.addListener(P,"mouseover",E);google.maps.event.addListener(P,"mouseout",x);H.push(P)};A.clearMarkers=function(){_.each(H,function(M){e.l("clearing");M.setMap(null)});H=[]};A.setPosition=function(M){$("#geo-container").css("display","block");y=$("#geo-zone").css("display","block").hover(K,L).get()[0];var O={},P=M.coords.latitude,N=M.coords.longitude,Q=new google.maps.LatLng(P,N);$.post("/home/heartbeat",{lat:P,lng:N,csrf_token:o},i);O.center=Q;z=new google.maps.Map(y,$.extend({},w,O));J=new google.maps.Marker({map:z,position:Q,icon:"http://hexo.in/img/marker.png",});I();google.maps.event.addDomListener(y,"mousedown",D);google.maps.event.addDomListener(y,"click",D);google.maps.event.addDomListener(y,"dblclick",D);google.maps.event.addDomListener(y,"contextmenu",D)};A.init=function(){if(!B){C.getCurrentPosition(A.setPosition)}B=true};return A})((!!window.navigator)&&(!!window.navigator.geolocation));s=(function(){var B={},A={menu_id:"#heartbeat-menu",socket_url:"/home/heartbeat",container:"#notification-list"},z,w=0,x,y,v;v=function(){if(w>0){y.text(w).css("display","block")}else{y.text(0).css("display","none")}};B.update=function(E){if(e.type(E)!=="array"){return false}x.html("");w=E.length;var D="";for(var C=0;C<E.length;C++){if(E[C].type=="game"){D+=e.template("game-notification",E[C])}else{D+=e.template("friend-notification",E[C])}}x.html(D);v()};B.init=function(){e.l("setting up the heartbeat view");t.init(A.menu_id);x=$(A.container);y=$(A.menu_id).find("span.bubble");w=x.children("li").length;z=h({url:A.socket_url,token:q.token,events:{update:_.bind(B.update,B)}});z.open();v()};return B})();t=(function(){var y,E,x,w,A,v,z=null,D,C=false,B;A=function(F){if(F.keyCode!==27){return}w.call(this);return F.preventDefault&&F.preventDefault()};x=function(){if(!C){return}if(z!==null){w.call(z)}z=this;this.addClass("open");b(d).on("keydown",_.bind(A,this))};w=function(){if(!C){return}z=null;this.removeClass("open");b(d).off("keydown",_.bind(A,this))};E=function(){if(!C){return}return this.hasClass("open")?w.call(this):x.call(this)};y=function(F){v=b(F);if(v.length<1){return false}D=(function(G){return function(){E.call(G)}})(v);v.on("click","button.toggle",D);C=true};B={open:x,close:w,init:y,toggle:E};return B})();j=function(){if(d.getElementById(String(u).substring(0,5))!==null){o=b("#"+String(u).substring(0,5)).find('input[type="hidden"]').val()}if(d.getElementById("settings-menu")!==null){t.init("#settings-menu")}if(d.getElementById("chatist-menu")!==null){t.init("#chatist-menu")}if(d.getElementById("to-top")!==null){b("#to-top").click(l)}if(d.getElementById("heartbeat-menu")!==null){s.init()}if(d.getElementById("geo-zone")!==null){g.init()}if(d.getElementById("chatroom-pullout")!==null){a.renderAll(b("#chatroom-pullout"),b("#chatlist-menu-list"))}};r.Utils=e;r.Chat=a;r.Socket=h;r.User=f;r.Entry=e.Entry;r.Geo=g;p.hexo=r;r.Entry(j)})(window);