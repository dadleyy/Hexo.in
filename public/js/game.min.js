/* ******************************************* *
 * Game.min.js                                 *
 * (c) 2013 Danny Hadley under the MIT license *
 * ******************************************* */(function(l){var y,e,f,t,d=hexo.Utils,p=null,v,n,m,x,c,k,q,g,r={},b=1,u=null,o=false,a=function(w){var z=$(w.target);return(function(A){if(A.success){z.addClass("dis")}})},h=function(w){if(p.visitor==false){return false}if(b==2){p.visitor.addFriend(p.challenger.username,a(w))}else{p.challenger.addFriend(p.visitor.username,a(w))}return w.preventDefault&&w.preventDefault()},i=function(){v=document.getElementById("render-zone");k=document.getElementById("chat-zone");n=$("#turn-indicator");m=$("#challenger-score");x=$("#visitor-score");var A=d3.select(document.body).append("svg"),z=A.append("defs"),w=z.append("polygon");w.attr(g.hexo);A.attr(g.helpersvg);$(document).on("click","section.ingame-menu a.add-friend",h)},s=function(B,z){var C=[];z.token=B.token||(C.push("no key")&&false);z.uid=d.uid();p=z;z.score=B.score||{visitor:0,challenger:0};z.state=B.state;z.tiles=B.tiles;z.turn=B.turn||0;if(B.no_live===true){z.no_live=true;return true}var w={events:{update:_.bind(z.updateChat,z)}},A=$.extend({},w,B.chatroom);z.challenger=hexo.User(B.challenger);z.visitor=(B.visitor)?hexo.User(B.visitor):false;if(z.visitor&&z.visitor.active&&!z.challenger.active){b=2}else{if(!z.visitor||(!z.visitor.active&&z.challenger.active)){b=1}}z.chatroom=hexo.Chat(A,true);z.socket=hexo.Socket({url:g.gameserver.socket,flag:B.flag,token:z.token,events:{update:_.bind(z.update,z),close:_.bind(z.end,z)}});if(C.length>0){d.l("was unable to initialize the game","err");z.errored=true}return C.length>0},j=function(z){d.l("Document is ready, rendering game");var D=z.dom,w=d3.select(v).append("svg"),C={},A,B;for(B=0;B<g.layers.length;B++){A=g.layers[B];C[A]=w.append("g");C[A].attr({"data-name":A,transform:d.tsm(0,0)});if(r[A]){r[A].call(z,C[A])}}z.msgbox=t({selector:"#game-message-box"});w.attr(g.dimensions);D.svg=w;D.layers=C;if(z.state==3){z.resolve()}$("a.reset-game").click(_.bind(z.reset,z));z.draw();if(z.no_live===true){return true}c=z.chatroom.registerForm({form:document.getElementById("chat-input"),});z.socket.open();z.chatroom.start()};r={game:function(F){d.l("rendering game layer");var J=100,I=130,M=0,C=[3,4,5,6,5,4,3],K=0,B=-1,G,E,H=0,A=0,w={},z;for(var D in this.tiles){if(!this.tiles.hasOwnProperty(D)){continue}z=this.tiles[D];D=d.pint(D);if(D==19){K++}if(K>C[M]){M++;K=0;I+=B*30}if(M>=Math.floor(C.length*0.5)){B=1}G=J+(M*54);E=I+(K*60);K++;z.indx=D;var L=f(z,this);w[D]=L.render(F,G,E)}this.tiles=w},ui:function(w){}};q=g={chattemplate:"chat-message-template",dimensions:{width:"540px",height:"440px"},gameserver:{socket:"/socket/game",moves:"/game/move"},helpersvg:{width:"0px",height:"0px",id:"svghelper"},layers:["game","ui"],hexo:{points:"16.326,28.101 -16.174,28.188 -32.5,0.086 -16.326,-28.101 16.174,-28.188 32.5,-0.086",id:"hexo"},gamehexo:{"xlink:href":"#hexo",fill:"#333",style:"cursor:pointer"},visitorhexo:{fill:"#ce334c"},challengerhexo:{fill:"#00ccff"},hexotext:{"text-anchor":"middle",fill:"#eee","font-size":"12px",x:0,y:5,style:"font-family:'Open Sans',sans-serif;font-weight:400;cursor:pointer;"}};t=function(w){return new t.ns.rig(w)};t.ns=t.prototype=(function(){var B={version:"1.0",constructor:t,},z={selector:"#game-message-box",container:"body",style:{width:"400px",height:"150px",left:"50%","margin-left":"-200px",position:"absolute",top:"-200px"},anTime:600,anEase:"easeOutBounce"},w,A;w=function(){this.container.stop().animate({top:"100px"},z.anTime,z.anEase);$(document).on("keyup",_.bind(A,this))};A=function(C){if(C.keyCode&&C.keyCode!==27){return}$(document).off("keyup");this.container.stop().animate({top:"-200px"},z.anTime,z.anEase)};B.rig=function(D){var C=$.extend({},z,D);this.container=$(z.container).find(z.selector).css(z.style);this.container.on("click","button.closer",_.bind(A,this))};B.notify=function(F,C){var D=(C===true)?true:false,E=d.template("game-messagebox",{message:F,homebtn:D});this.container.html(E);w.call(this)};return B})();t.ns.rig.prototype=t.ns;f=function(w,z){return new f.ns.rig(w,z)};f.ns=f.prototype=(function(){var B={version:"1.0",constructor:f,dom:{},errored:false},z,A,w;A=function(){if(this.game.turn!==b){return this.game.notify("its not your turn!")}else{if(this.state!==0){return this.game.notify("this tile is already flipped")}}this.game.move(this)};z=function(){this.dom.tile.transition().duration(620).ease("elastic").attr("transform","scale(1.08)")};w=function(){this.dom.tile.transition().duration(620).ease("elastic").attr("transform","scale(1.0)")};B.rig=function(D,C){if(!C){this.errored=true;return false}this.game=C;this.uid=d.uid();this.indx=D.indx;this.state=D.state||0;this.value=D.value||0};B.render=function(D,C,H){var F=D.append("g").attr("data-uid",this.uid),E=F.append("use"),G=F.append("text");G.attr(g.hexotext).text(this.value);F.attr("transform",d.tsm(C,H));F.on("mouseover",_.bind(z,this)).on("mouseout",_.bind(w,this)).on("click",_.bind(A,this));this.dom={group:F,tile:E};return this.draw()};B.setState=function(C){this.state=d.pint(C)};B.draw=function(){this.dom.tile.attr(g.gamehexo);if(d.pint(this.state)==1){this.dom.tile.attr(g.challengerhexo)}else{if(d.pint(this.state)==2){this.dom.tile.attr(g.visitorhexo)}}return this};return B})();f.ns.rig.prototype=f.prototype;e=function(w){return new e.ns.rig(w)};e.ns=e.prototype=(function(){var A={version:"1.0",constructor:e,errored:false,dom:{}},z=function(B){return{csrf_token:o,token:this.token,tile:B}},w=false;A.rig=function(B){if(B===undefined||!B){this.errored=true;return false}d.l("Preparing game for document.ready");return s(B,this)};A.end=function(){if(this.state!==3){this.notify("the other player has quit the game")}this.socket.close()};A.resolve=function(){var B=(this.score.visitor>this.score.challenger)?this.visitor:this.challenger;this.end();return this.notify(B.username+" has won the game!",true)};A.postMove=function(B){if(!B.success){return this.notify(B)}this.tiles[B.update.key].setState(B.update.state);this.draw();setTimeout(function(){w=false},1000)};A.update=function(D){if(!D||D.state===null){this.end()}if(D.state===1&&this.state===0){this.state=1;this.socket.force()}if(this.visitor===false&&D.visitor!=false){d.l("The visitor has joined");var C=hexo.User(D.visitor),B=$("#visitor-info");B.find("h1.name").text(C.username);B.find("dl.wins dd").text(C.wins);B.find("dl.losses dd").text(C.losses);this.visitor=C}_.each(D.tiles,function(F,E){if(d.pint(this.tiles[E].value)===d.pint(F.value)){this.tiles[E].state=d.pint(F.state)}},this);this.score=D.score;this.turn=D.turn;if(D.state===3&&D.flag==="complete"){this.state=3;this.resolve()}this.draw()};A.draw=function(){d.l("redrawing the game");var B=20;switch(this.turn){case 1:B=20;break;case 2:B=540;break;default:break}n.stop().animate({left:B+"px"},d.anTime,d.anEase);m.text(this.score.challenger);x.text(this.score.visitor);_.each(this.tiles,function(C){C.draw()})};A.move=function(B){if(w){return false}w=true;var C=z.apply(this,[B]);$.post(g.gameserver.moves,{csrf_token:o,token:this.token,tile:{value:B.value,state:b}},_.bind(this.postMove,this),"json")};A.notify=function(C,B){this.msgbox.notify(C,B)};A.updateChat=function(B){d.l("updating game chat");$(k).html("");_.each(B,function(F){var D=F.user||"",E=F.message||"",C=d.template(g.chattemplate,{user:D,text:E});k.innerHTML+=C});$(k).scrollTop($(k).height()+1000)};A.resetCheck=function(B){};A.reset=function(B){$.post("/game/reset",{csrf_token:o,token:this.token},_.bind(this.resetCheck,this));return B.preventDefault&&B.preventDefault()};return A})();e.ns.rig.prototype=e.prototype;y=function(z,w){i();o=w;u=z;j(p)};hexo.Game=e;hexo.Entry(y)})(window);