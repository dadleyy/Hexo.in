/* ******************************************* *
 * Game.min.js                                 *
 * (c) 2013 Danny Hadley under the MIT license *
 * ******************************************* */
(function(j){var u,d,e,q,c=hexo.Utils,r={},s,l,k,t,b,i,n,f,o={},a=1,m=false,g=function(){s=document.getElementById("render-zone");i=document.getElementById("chat-zone");l=$("#turn-indicator");k=$("#challenger-score");t=$("#visitor-score");var x=d3.select(document.body).append("svg"),w=x.append("defs"),v=w.append("polygon");v.attr(f.hexo);x.attr(f.helpersvg)},p=function(y,w){var z=[];w.token=y.token||(z.push("no key")&&false);w.uid=c.uid();r[w.uid]=w;w.score=y.score||{visitor:0,challenger:0};w.challenger=hexo.User(y.challenger);w.visitor=(y.visitor)?hexo.User(y.visitor):false;if(w.visitor&&w.visitor.active&&!w.challenger.active){a=2}else{if(!w.visitor||(!w.visitor.active&&w.challenger.active)){a=1}}w.state=y.state;w.tiles=y.tiles;w.turn=y.turn||0;var v={events:{update:_.bind(w.updateChat,w)}},x=$.extend({},v,y.chatroom);w.chatroom=hexo.Chat(x,true);w.socket=hexo.Socket({url:f.gameserver.socket,token:w.token,events:{update:_.bind(w.update,w),close:_.bind(w.end,w)}});if(z.length>0){c.l("was unable to initialize the game","err");w.errored=true}return z.length>0},h=function(w){c.l("Document is ready, rendering game");var A=w.dom,v=d3.select(s).append("svg"),z={},x,y;for(y=0;y<f.layers.length;y++){x=f.layers[y];z[x]=v.append("g");z[x].attr({"data-name":x,transform:c.tsm(0,0)});if(o[x]){o[x].call(w,z[x])}}b=w.chatroom.registerForm({form:document.getElementById("chat-input"),});w.socket.open();w.chatroom.start();w.msgbox=q({selector:"#game-message-box"});v.attr(f.dimensions);A.svg=v;A.layers=z;if(w.state==3){w.resolve()}w.draw()};o={game:function(E){c.l("rendering game layer");var I=100,H=130,L=0,B=[3,4,5,6,5,4,3],J=0,A=-1,F,D,G=0,z=0,v={},w;for(var C in this.tiles){if(!this.tiles.hasOwnProperty(C)){continue}w=this.tiles[C];C=c.pint(C);if(C==19){J++}if(J>B[L]){L++;J=0;H+=A*30}if(L>=Math.floor(B.length*0.5)){A=1}F=I+(L*54);D=H+(J*60);J++;var K=e(w,this);v[C]=K.render(E,F,D)}this.tiles=v},ui:function(v){}};n=f={chattemplate:"chat-message-template",dimensions:{width:"540px",height:"440px"},gameserver:{socket:"/game/socket",moves:"/game/move"},helpersvg:{width:"0px",height:"0px",id:"svghelper"},layers:["game","ui"],hexo:{points:"16.326,28.101 -16.174,28.188 -32.5,0.086 -16.326,-28.101 16.174,-28.188 32.5,-0.086",id:"hexo"},gamehexo:{"xlink:href":"#hexo",fill:"#333",style:"cursor:pointer"},visitorhexo:{fill:"#ce334c"},challengerhexo:{fill:"#00ccff"},hexotext:{"text-anchor":"middle",fill:"#eee","font-size":"12px",x:0,y:5,style:"font-family:'Open Sans',sans-serif;font-weight:400;cursor:pointer;"}};q=function(v){return new q.ns.rig(v)};q.ns=q.prototype=(function(){var y={version:"1.0",constructor:q,},w={selector:"#game-message-box",container:"body",style:{width:"400px",height:"150px",left:"50%","margin-left":"-200px",position:"absolute",top:"-200px"},anTime:600,anEase:"easeOutBounce"},v,x;v=function(){this.container.stop().animate({top:"100px"},w.anTime,w.anEase);$(document).on("keyup",_.bind(x,this))};x=function(z){if(z.keyCode&&z.keyCode!==27){return}$(document).off("keyup");this.container.stop().animate({top:"-200px"},w.anTime,w.anEase)};y.rig=function(A){var z=$.extend({},w,A);this.container=$(w.container).find(w.selector).css(w.style);this.container.on("click","button.closer",_.bind(x,this))};y.notify=function(C,z){var A=(z===true)?true:false,B=c.template("game-messagebox",{message:C,homebtn:A});this.container.html(B);v.call(this)};return y})();q.ns.rig.prototype=q.ns;e=function(v,w){return new e.ns.rig(v,w)};e.ns=e.prototype=(function(){var y={version:"1.0",constructor:e,dom:{},errored:false},w,x,v;x=function(){if(this.game.turn!==a){return this.game.notify("its not your turn!")}else{if(this.state!==0){return this.game.notify("this tile is already flipped")}}this.game.move(this)};w=function(){this.dom.tile.transition().duration(620).ease("elastic").attr("transform","scale(1.08)")};v=function(){this.dom.tile.transition().duration(620).ease("elastic").attr("transform","scale(1.0)")};y.rig=function(A,z){if(!z){this.errored=true;return false}this.game=z;this.uid=c.uid();this.state=A.state||0;this.value=A.value||0};y.render=function(A,z,E){var C=A.append("g").attr("data-uid",this.uid),B=C.append("use"),D=C.append("text");D.attr(f.hexotext).text(this.value);C.attr("transform",c.tsm(z,E));C.on("mouseover",_.bind(w,this)).on("mouseout",_.bind(v,this)).on("click",_.bind(x,this));this.dom={group:C,tile:B};return this.draw()};y.setState=function(z){this.state=c.pint(z)};y.draw=function(){this.dom.tile.attr(f.gamehexo);if(c.pint(this.state)==1){this.dom.tile.attr(f.challengerhexo)}else{if(c.pint(this.state)==2){this.dom.tile.attr(f.visitorhexo)}}return this};return y})();e.ns.rig.prototype=e.prototype;d=function(v){return new d.ns.rig(v)};d.ns=d.prototype=(function(){var x={version:"1.0",constructor:d,errored:false,dom:{}},w=function(y){return{csrf_token:m,token:this.token,tile:y}},v=false;x.rig=function(y){if(y===undefined||!y){this.errored=true;return false}c.l("Preparing game for document.ready");return p(y,this)};x.end=function(){if(this.state!==3){this.notify("the other player has quit the game")}this.socket.close()};x.resolve=function(){var y=(this.score.visitor>this.score.challenger)?this.visitor:this.challenger;this.end();return this.notify(y.username+" has won the game!",true)};x.postMove=function(y){if(!y.success){return this.notify(y.msg)}this.tiles[y.update.key].setState(y.update.state);this.draw();setTimeout(function(){v=false},1000)};x.update=function(A){if(!A||A.state===null){this.end()}if(A.state===1&&this.state===0){this.state=1;this.socket.force()}if(this.visitor===false&&A.visitor!=false){c.l("The visitor has joined");var z=hexo.User(A.visitor),y=$("#visitor-info");y.find("h1.name").text(z.username);y.find("dl.wins dd").text(z.wins);y.find("dl.losses dd").text(z.losses);this.visitor=z}_.each(A.tiles,function(C,B){if(c.pint(this.tiles[B].value)===c.pint(C.value)){this.tiles[B].state=c.pint(C.state)}},this);this.score=A.score;this.turn=A.turn;if(A.state===3&&A.flag==="complete"){this.state=3;this.resolve()}this.draw()};x.draw=function(){c.l("redrawing the game");var y=20;switch(this.turn){case 1:y=20;break;case 2:y=540;break;default:break}l.stop().animate({left:y+"px"},c.anTime,c.anEase);k.text(this.score.challenger);t.text(this.score.visitor);_.each(this.tiles,function(z){z.draw()})};x.move=function(y){if(v){return false}v=true;var z=w.apply(this,[y]);$.post(f.gameserver.moves,{csrf_token:m,token:this.token,tile:{value:y.value,state:a}},_.bind(this.postMove,this))};x.notify=function(z,y){this.msgbox.notify(z,y)};x.updateChat=function(y){c.l("updating game chat");$(i).html("");_.each(y,function(C){var A=C.user||"",B=C.message||"",z=c.template(f.chattemplate,{user:A,text:B});i.innerHTML+=z});$(i).scrollTop($(i).height()+1000)};return x})();d.ns.rig.prototype=d.prototype;u=function(x,w){g();m=w;for(var v in r){h(r[v])}};hexo.Game=d;hexo.Entry(u)})(window);